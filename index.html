<html>
<head>
	<title>FRep CSG</title>

	<script src="js/jquery.js"></script>
	<script src="js/jquery.mousewheel.js"></script>
	<script src="js/modernizr.min.js"></script>
	<script src="js/sisyphus.min.js"></script>
	<script src="js/date.format.js"></script>
	<script src="js/lightgl.js"></script>

	<script src="WorkerConsole.js"></script>

	<script src="frep-csg.js"></script>
	<script src="viewer.js"></script>

	<link rel="stylesheet" href="css/frep-csg.css" type="text/css" charset="utf-8" />

	<script>
		function notify(msg, append){
			var d = new Date();
			if (append){
				$('#info1').append(msg);	
			} else {
				$('#info1').prepend(d.format('h:MM:ss > ') + msg+"\n");	
			}
		}

		function canSaveStl(){
			return (window.webkitRequestFileSystem != undefined);
		}

		function working(){
			$('#spinner').show();
		}

		function notworking(){
			$('#spinner').hide();
		}

		var defaultEditorContent = "var a = CSG.sphere({center:[3,3,3], radius:2});\nvar b = CSG.block({vertex:[0,0,0], dx:4,dy:4,dz:4});\n\nreturn  b.union(a);\n\n//return  b.intersect(a);\n\n//return  b.subtract(a);\n\n//return  a.subtract(b);\n\n//return CSG.torusX({center:[2,2,2], R:2, r0:1});\n\n//return CSG.gyroid({center:[2,2,2], t:0.1});\n\n//return CSG.ellipsoid({center:[2,2,2], a:1,b:2,c:3}, {color:[0,5,5]});";

		function getBoundingBox(){
			var minX = parseFloat($('#boundaryBoxMinX').val());
			var minY = parseFloat($('#boundaryBoxMinY').val());
			var minZ = parseFloat($('#boundaryBoxMinZ').val());
			var maxX = parseFloat($('#boundaryBoxMaxX').val());
			var maxY = parseFloat($('#boundaryBoxMaxY').val());
			var maxZ = parseFloat($('#boundaryBoxMaxZ').val());
			return {min:{x:minX,y:minY,z:minZ},max:{x:maxX,y:maxY,z:maxZ}};
		}

		function setBoundingBox(bb){
			$('#boundaryBoxMinX').val(bb.min.x).change();
			$('#boundaryBoxMinY').val(bb.min.y).change();
			$('#boundaryBoxMinZ').val(bb.min.z).change();
			$('#boundaryBoxMaxX').val(bb.max.x).change();
			$('#boundaryBoxMaxY').val(bb.max.y).change();
			$('#boundaryBoxMaxZ').val(bb.max.z).change();
		}

		function incrementProgress(amount){
			var current = $('#zProgress').val();
			$('#zProgress').val(current+amount);
		}

		function resetProgress(max){
			$('#zProgress').val(0);
			if (max != undefined){
				$('#zProgress').attr("max", max);	
			}
		}

		$(document).ready(function() {
			if (!Modernizr.webgl){
				notify("This app needs webGL - Google Chrome would be a good choice of browser.")
				return 
			}
			if (!canSaveStl()){
				notify("This app requires webkitRequestFileSystem in order to save STL files. Google Chrome has this feature.")
				$('#stl').attr("disabled", true);
				$('#stl').attr("title", "This app requires webkitRequestFileSystem in order to save STL files.");
			}

			var model;
			
			new Viewer(800, 600, 120, 'viewer1');

			if (localStorage.getItem("lastFRepEdit") != undefined){
				$('#editor1').val(localStorage.getItem("lastFRepEdit"));
			} else {
				$('#editor1').val(defaultEditorContent);
			}

			$('#polygonise').click(function(e){			
				working();
				resetProgress($('#grid').val());

				var f = new Function('', $('#editor1').val());
				model = f();

				var grid = parseFloat($('#grid').val());
				
				var isosurface = parseFloat($('#isosurface').val());

				model.polygonise(grid, getBoundingBox(), isosurface, function(mesh){
					viewer.updateMesh(mesh);
					notworking();
					setTimeout(function(){
						resetProgress();
					}, 1000);			
				});
					
			});

			$('#editor1').live('keyup blur', function(){
				localStorage.setItem("lastFRepEdit", $(this).val());
			});

			$('#controlsForm').sisyphus({excludeFields: $('.sisyphusignore')});

			$('#lineOverlay').change(function(){
				Viewer.lineOverlay = ($(this).attr('checked') == 'checked');
			});
			$('#lineOverlay').change();


			$('#stl').click(function(){
				if (model == undefined || ! (model instanceof CSG)){
					notify("Model not yet created. Polygonise!")
				} else {
					notify("Generating STL...");
					working();
					model.toStl(function(){
						notworking();
						setTimeout(function(){
							resetProgress();
						}, 1000);
					});
				}				
			});

			$('#clear').click(function(){
				$('#info1').html('')
			});

			$('#boundaryBoxMinAll').blur(function(){
				var v = $(this).val();
				$('#boundaryBoxMinX').val(v).change();
				$('#boundaryBoxMinY').val(v).change();
				$('#boundaryBoxMinZ').val(v).change();
			});

			$('#boundaryBoxMaxAll').blur(function(){
				var v = $(this).val();
				$('#boundaryBoxMaxX').val(v).change();
				$('#boundaryBoxMaxY').val(v).change();
				$('#boundaryBoxMaxZ').val(v).change();
			});

			$('#resetEditor').click(function(){
				if (confirm("Reset Editor?")){
					$('#editor1').val(defaultEditorContent);
					localStorage.setItem("lastFRepEdit",defaultEditorContent);
				}
			});

			$('#findBoundingBox').click(function(){

				if (model == undefined || ! (model instanceof CSG)){
					notify("Model not yet created. Polygonise!")
				} else {
					working();
					setTimeout(function(){
						var workers = new Array(6)
						var resultsCount = 0;

						for (var i = 0; i <6; i++){
							workers[i] = new Worker('BoundaryBoxLimitWorker.js');
							workers[i].onmessage =  function(e) {
								var field = $('#boundaryBox'+e.data.dir.substr(0,1).toUpperCase()+e.data.dir.substr(1)+e.data.axis.toUpperCase())
								field.val(e.data.val).change();
								field.addClass('updated');

								if (++resultsCount == 6){
									notworking();
									setTimeout(function(){
										$('.updated').removeClass('updated');
									}, 2000);
								}
							}
						}
						workers[0].postMessage({'axis':'x','dir':'min','funcDef':model.funcDef,'params':model.params, 'attrs':model.attrs});
						workers[1].postMessage({'axis':'x','dir':'max','funcDef':model.funcDef,'params':model.params, 'attrs':model.attrs});
						workers[2].postMessage({'axis':'y','dir':'min','funcDef':model.funcDef,'params':model.params, 'attrs':model.attrs});
						workers[3].postMessage({'axis':'y','dir':'max','funcDef':model.funcDef,'params':model.params, 'attrs':model.attrs});
						workers[4].postMessage({'axis':'z','dir':'min','funcDef':model.funcDef,'params':model.params, 'attrs':model.attrs});
						workers[5].postMessage({'axis':'z','dir':'max','funcDef':model.funcDef,'params':model.params, 'attrs':model.attrs});
						
					}, 100);					
				}
			});

			if ($('#polygoniseOnLoad').attr('checked')) {
				$('#polygonise').click();
			}

		});
	</script>
</head>
<body>


	<textarea id="editor1" class="editor">
	</textarea>
	<div id="viewer1" class="viewer"></div>

	<br clear="both">

	<div id="controls1" class="controls">
		<form id="controlsForm">

			<input type="button" value="Polygonise" id="polygonise" name="polygonise" />
			&nbsp;<input type="button" value="STL" id="stl" name="stl" />
			&nbsp;<input type="button" value="Reset" id="resetEditor" name="resetEditor" />
			&nbsp;<img id="spinner" src="images/spinner.gif">
			<br>
				<progress id="zProgress" max="100" value="0"></progress>
			<br>
		
			Grid: <input class="setting" id="grid" name="grid" type="number" value="40"/>&nbsp;Isosurface:<input class="setting" id="isosurface" name="isosurface" type="number" value="0.0" step="0.1"/><br>
				
			<fieldset id="boundaryBox">
				<legend>Boundary Box</legend>
				Min: 
				x <input class="setting" id="boundaryBoxMinX" name="boundaryBoxMinX" type="number" value="-10" step="0.5"/>
				y <input class="setting" id="boundaryBoxMinY" name="boundaryBoxMinY" type="number" value="-10" step="0.5"/>
				z <input class="setting" id="boundaryBoxMinZ" name="boundaryBoxMinZ" type="number" value="-10" step="0.5"/>
				&nbsp;(All: <input id="boundaryBoxMinAll" name="boundaryBoxMinAll" class="sisyphusignore" type="number" value="" step="0.5"/>)
				<br>
				Max: 
				x <input class="setting" id="boundaryBoxMaxX" name="boundaryBoxMaxX" type="number" value="15" step="0.5"/>
				y <input class="setting" id="boundaryBoxMaxY" name="boundaryBoxMaxY" type="number" value="15" step="0.5"/>
				z <input class="setting" id="boundaryBoxMaxZ" name="boundaryBoxMaxZ" type="number" value="15" step="0.5"/>
				&nbsp;(All: <input id="boundaryBoxMaxAll" name="boundaryBoxMaxAll" class="sisyphusignore" type="number" value="" step="0.5"/>)
				<br>
				<a href="javascript://" id="findBoundingBox">calculate<a/>
			</fieldset>

			<br>
			LineOverlay: <input class="setting" id="lineOverlay" name="lineOverlay" type="checkbox"/>
			<br>
			Polygonise on Load: <input class="setting" id="polygoniseOnLoad" name="polygoniseOnLoad" type="checkbox"/>
		</form>
	</div>

<textarea id="info1" class="info" readonly></textarea>
<br>
<input type="button" value="Clear" id="clear" name="clear" />
</body>
</html>