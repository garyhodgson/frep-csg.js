<html>
<head>
	<title>FRep CSG</title>

	<script src="jquery.js"></script>
	<script src="jquery.mousewheel.js"></script>
	<script src="modernizr.min.js"></script>
	<script src="sisyphus.min.js"></script>
	<script src="date.format.js"></script>
	<script src="lightgl.js"></script>
	<script src="frep-csg.js"></script>
	<script src="viewer.js"></script>

	<style>
		.editor { width: 39%; height: 600px; }
		.viewer { float: right; width: 60%; height: 600px; background: #EEE;}
		.controls { float: left; width: 38%; height: 200px; padding: 5px; margin-top: 5px; border:1px dashed grey; }
		.info {  width: 60%; height: 200px; padding: 5px; margin: 5px; }
		input[type=number] { width: 60px;}
		#grid input { width: 30px;}
		canvas { cursor: move; }
	</style>

	<script>
		function notify(msg){
			var d = new Date();
			//$('#info1').prepend(d.format('h:MM:ss > ') + msg+"\n");
			$('#info1').append(msg);
		}

		$(document).ready(function() {

			var model;
			
			new Viewer(800, 600, 30, 'viewer1');

			if (localStorage.getItem("lastFRepEdit") != undefined){
				$('#editor1').val(localStorage.getItem("lastFRepEdit"));
			}

			$('#polygonise').click(function(e){			
				$('#notice').html("Working...");
				setTimeout(function(){
					var f = new Function('', $('#editor1').val());
					model = f();

					var grid = parseFloat($('#grid').val());
					var minX = parseFloat($('#boundaryBoxMinX').val());
					var minY = parseFloat($('#boundaryBoxMinY').val());
					var minZ = parseFloat($('#boundaryBoxMinZ').val());
					var maxX = parseFloat($('#boundaryBoxMaxX').val());
					var maxY = parseFloat($('#boundaryBoxMaxY').val());
					var maxZ = parseFloat($('#boundaryBoxMaxZ').val());
					var isosurface = parseFloat($('#isosurface').val());
				
					viewer.updateMesh(model.toMesh(grid, {min:[minX,minY,minZ],max:[maxX,maxZ,maxZ]}, isosurface));
					$('#notice').html("Done.");
					setTimeout(function(){$('#notice').html("")},2000);
				},100);				
			});

			$('#editor1').live('keyup blur', function(){
				localStorage.setItem("lastFRepEdit", $(this).val());
			});

			$('#lineOverlay').change(function(){
				Viewer.lineOverlay = ($(this).attr('checked') == 'checked');
			});
			$('#lineOverlay').change();

			$('#controlsForm').sisyphus();

			$('#stl').click(function(){
				if (model == undefined || ! (model instanceof CSG)){
					notify("Model not yet created. Polygonise!")
				} else {
					notify("Generating STL...")
					model.toStl();
				}				
			});

			$('#clear').click(function(){
				$('#info1').html('')
			});

		});
	</script>
</head>
<body>


	<textarea id="editor1" class="editor">
var a = CSG.sphere({center:[3,3,3], radius:2});
var b = CSG.block({vertex:[0,0,0], dx:4,dy:4,dz:4});

return  b.union(a);

//return  b.intersect(a);

//return  b.subtract(a);

//return  a.subtract(b);

//return CSG.torusX({center:[2,2,2], R:2, r0:1});

//return CSG.gyroid({center:[2,2,2], t:0.1});

//return CSG.ellipsoid({center:[2,2,2], a:1,b:2,c:3}, {color:[0,5,5]});
	</textarea>
	<div id="viewer1" class="viewer"></div>

	<br clear="both">

	<div id="controls1" class="controls">
		<form id="controlsForm">

			<input type="button" value="Polygonise" id="polygonise" name="polygonise" />&nbsp;<input type="button" value="STL" id="stl" name="stl" />&nbsp;<span id="notice"></span>
			<br>
			
			Grid: <input class="setting" id="grid" name="grid" type="number" value="40"/>&nbsp;Isosurface:<input class="setting" id="isosurface" name="isosurface" type="number" value="0.0"/><br>
				
			<fieldset id="boundaryBox">
				<legend>Boundary Box</legend>
				Min: 
				x <input class="setting" id="boundaryBoxMinX" name="boundaryBoxMinX" type="number" value="-10"/>
				y <input class="setting" id="boundaryBoxMinY" name="boundaryBoxMinY" type="number" value="-10"/>
				z <input class="setting" id="boundaryBoxMinZ" name="boundaryBoxMinZ" type="number" value="-10"/>
				<br>
				Max: 
				x <input class="setting" id="boundaryBoxMaxX" name="boundaryBoxMaxX" type="number" value="15"/>
				y <input class="setting" id="boundaryBoxMaxY" name="boundaryBoxMaxY" type="number" value="15"/>
				z <input class="setting" id="boundaryBoxMaxZ" name="boundaryBoxMaxZ" type="number" value="15"/>
				<br>
			</fieldset>

			<br>
			LineOverlay: <input class="setting" id="lineOverlay" name="lineOverlay" type="checkbox"/>
		</form>
	</div>

<textarea id="info1" class="info" readonly></textarea>
<br>
<input type="button" value="Clear" id="clear" name="clear" />

	<script>
			var microstructureExample = function(){

				var lattice = new CSG({}, {}, function(coords) {

					var l = 0.075;
					var p = 0;
					var q = 3;

					var sx = Math.sin((q * coords[0]) + p) - l;
					var sy = Math.sin((q * coords[1]) + p) - l;
					var sz = Math.sin((q * coords[2]) + p) - l;

					var rx = sy & sz;
					var ry = sx & sz;
					var rz = sx & sy;

					return rx | ry | rz;
				});
				

				var sphere = CSG.sphere({center:[0,0,0],radius:10});

				var spherehollow = CSG.sphere({center:[0,0,0],radius:9});

				var shell = sphere.subtract(spherehollow);

				var block = CSG.block({vertex:[-10,-10,0],dx:20,dy:20,dz:10});

				var support = lattice.intersect(spherehollow);

				var supportshell = shell.union(support)

				return supportshell.subtract(block);
			}();
			
	</script>
</body>
</html>