<html>
<head>
	<title>FRep CSG</title>

	<script src="js/jquery.js"></script>
	<script src="js/jquery.mousewheel.js"></script>
	<script src="js/jquery.textarea.js"></script>
	<script src="js/modernizr.min.js"></script>
	<script src="js/sisyphus.min.js"></script>
	<script src="js/date.format.js"></script>
	<script src="js/lightgl.js"></script>
	<script src="js/underscore-min.js"></script>

	<script src="WorkerConsole.js"></script>

	<script src="frep-csg.js"></script>
	<script src="viewer.js"></script>

	<link rel="stylesheet" href="css/frep-csg.css" type="text/css" charset="utf-8" />

	<script>
	
		function notify(msg, append){
			var d = new Date();
			if (append){
				$('#log1').append(msg);	
			} else {
				$('#log1').prepend(d.format('h:MM:ss > ') + msg+"\n");	
			}
		}

		function canSaveStl(){
			return (window.webkitRequestFileSystem != undefined);
		}

		function working(){
			$('#spinner').show();
		}

		function notworking(){
			$('#spinner').hide();
		}

		var defaultEditorContent = "var a = CSG.sphere({center:[3,3,3], radius:2}, {color:[1,0,0]});\nvar b = CSG.block({vertex:[0,0,0], dx:4,dy:4,dz:4},{color:[0,1,0]});\n\nreturn  b.union(a);\n\n//return  b.intersect(a);\n\n//return  b.subtract(a);\n\n//return  a.subtract(b);\n\n//return CSG.torusX({center:[2,2,2], R:2, r0:1});\n\n//return CSG.gyroid({center:[2,2,2], t:0.1});\n\n//return CSG.ellipsoid({center:[2,2,2], a:1,b:2,c:3}, {color:[0,5,5]});";

		function getBoundingBox(){
			var minX = parseFloat($('#boundaryBoxMinX').val());
			var minY = parseFloat($('#boundaryBoxMinY').val());
			var minZ = parseFloat($('#boundaryBoxMinZ').val());
			var maxX = parseFloat($('#boundaryBoxMaxX').val());
			var maxY = parseFloat($('#boundaryBoxMaxY').val());
			var maxZ = parseFloat($('#boundaryBoxMaxZ').val());
			return {min:{x:minX,y:minY,z:minZ},max:{x:maxX,y:maxY,z:maxZ}};
		}

		function setBoundingBox(bb){
			$('#boundaryBoxMinX').val(bb.min.x).change();
			$('#boundaryBoxMinY').val(bb.min.y).change();
			$('#boundaryBoxMinZ').val(bb.min.z).change();
			$('#boundaryBoxMaxX').val(bb.max.x).change();
			$('#boundaryBoxMaxY').val(bb.max.y).change();
			$('#boundaryBoxMaxZ').val(bb.max.z).change();
		}

		function incrementProgress(amount){
			var current = $('#zProgress').val();
			$('#zProgress').val(current+amount);
		}

		function resetProgress(max){
			$('#zProgress').val(0);
			if (max != undefined){
				$('#zProgress').attr("max", max);	
			}
		}

		$(document).ready(function() {
			if (!Modernizr.webgl){
				notify("This app needs webGL - Google Chrome would be a good choice of browser.")
				return 
			}
			if (!canSaveStl()){
				notify("This app requires webkitRequestFileSystem in order to save STL files. Google Chrome has this feature.")
				$('#stl').attr("disabled", true);
				$('#stl').attr("title", "This app requires webkitRequestFileSystem in order to save STL files.");
			}

			var model;

			var viewerWidth = $('#viewer1').width();
			var viewerHeight = $('#viewer1').height();

			new Viewer(viewerWidth, viewerHeight, 20, 'viewer1');

			$('#controlsForm').sisyphus({excludeFields: $('.sisyphusignore')});
			$('#editor1').tabby();

			if (localStorage.getItem("lastFRepEdit") != undefined){
				$('#editor1').val(localStorage.getItem("lastFRepEdit"));
			} else {
				$('#editor1').val(defaultEditorContent);
			}

			$('#sharpen').change(function(){
				sharpen = ($(this).attr('checked') == 'checked');
			});
			$('#sharpen').change();

			$('#showNormals').change(function(){
				showNormals = ($(this).attr('checked') == 'checked');
			});
			$('#showNormals').change();

			$('#showGrid').change(function(){
				showGrid = ($(this).attr('checked') == 'checked');
			});
			$('#showGrid').change();

			$('#showAxis').change(function(){
				showAxis = ($(this).attr('checked') == 'checked');
			});
			$('#showAxis').change();

			$('#polygonise').click(function(e){			

				working();
				resetProgress($('#gridZ').val());

				var f = new Function('', $('#editor1').val());
				model = f();

				var gridX = parseFloat($('#gridX').val());
				var gridY = parseFloat($('#gridY').val());
				var gridZ = parseFloat($('#gridZ').val());
				var numWorkers = parseFloat($('#numWorkers').val());				
				var isosurface = parseFloat($('#isosurface').val());

				model.polygonise({x:gridX,y:gridY,z:gridZ}, getBoundingBox(), isosurface, numWorkers, function(mesh){
					viewer.updateMesh(mesh);

					if ($('#zoomCentre').attr('checked') == 'checked'){
						$('#cameraCentre').click();
						$('#cameraZoom').click();
					}

					notworking();
					setTimeout(function(){
						resetProgress();
					}, 1000);			
				});
					
			});

			$('#editor1').live('keyup blur', function(){
				localStorage.setItem("lastFRepEdit", $(this).val());
			});

			$('#lineOverlay').change(function(){
				Viewer.lineOverlay = ($(this).attr('checked') == 'checked');
			});
			$('#lineOverlay').change();


			$('#stl').click(function(){
				if (model == undefined || ! (model instanceof CSG)){
					notify("Model not yet created. Polygonise!")
				} else {
					notify("Generating STL...");
					working();
					model.toStl(function(){
						notworking();
						setTimeout(function(){
							resetProgress();
						}, 1000);
					});
				}				
			});

			$('#clear').click(function(){
				$('#info1').html('')
			});

			$('#boundaryBoxMinAll').blur(function(){
				var v = $(this).val();
				if (v == '') return;
				$('#boundaryBoxMinX').val(v).change();
				$('#boundaryBoxMinY').val(v).change();
				$('#boundaryBoxMinZ').val(v).change();
			});

			$('#gridAll').blur(function(){
				var v = $(this).val();
				if (v == '') return;
				$('#gridX').val(v).change();
				$('#gridY').val(v).change();
				$('#gridZ').val(v).change();
			});

			$('#boundaryBoxMaxAll').blur(function(){
				var v = $(this).val();
				if (v == '') return;
				$('#boundaryBoxMaxX').val(v).change();
				$('#boundaryBoxMaxY').val(v).change();
				$('#boundaryBoxMaxZ').val(v).change();
			});

			$('#resetEditor').click(function(){
				if (confirm("Reset Editor?")){
					$('#editor1').val(defaultEditorContent);
					localStorage.setItem("lastFRepEdit",defaultEditorContent);
				}
			});

			$('#findBoundingBox').click(function(){

				if (model == undefined || ! (model instanceof CSG)){
					notify("Model not yet created. Polygonise!")
				} else {
					working();
					setTimeout(function(){
						var workers = new Array(6)
						var resultsCount = 0;

						for (var i = 0; i <6; i++){
							workers[i] = new Worker('BoundaryBoxLimitWorker.js');
							workers[i].onmessage =  function(e) {
								var field = $('#boundaryBox'+e.data.dir.substr(0,1).toUpperCase()+e.data.dir.substr(1)+e.data.axis.toUpperCase())
								field.val(e.data.val).change();
								field.addClass('updated');

								if (++resultsCount == 6){
									notworking();
									setTimeout(function(){
										$('.updated').removeClass('updated');
									}, 2000);
								}
							}
						}
						workers[0].postMessage({'axis':'x','dir':'min','funcDef':model.funcDef,'params':model.params, 'attrs':model.attrs});
						workers[1].postMessage({'axis':'x','dir':'max','funcDef':model.funcDef,'params':model.params, 'attrs':model.attrs});
						workers[2].postMessage({'axis':'y','dir':'min','funcDef':model.funcDef,'params':model.params, 'attrs':model.attrs});
						workers[3].postMessage({'axis':'y','dir':'max','funcDef':model.funcDef,'params':model.params, 'attrs':model.attrs});
						workers[4].postMessage({'axis':'z','dir':'min','funcDef':model.funcDef,'params':model.params, 'attrs':model.attrs});
						workers[5].postMessage({'axis':'z','dir':'max','funcDef':model.funcDef,'params':model.params, 'attrs':model.attrs});
						
					}, 100);					
				}
			});

			$('#cameraX').click(function(e){
				viewer.cameraAngle(270,0,0);
			});
			$('#cameraY').click(function(e){
				viewer.cameraAngle(270,0,270);
			});
			$('#cameraZ').click(function(e){
				viewer.cameraAngle(0,0,0);
			});
			$('#cameraIso').click(function(e){
				viewer.cameraAngle(315,0,315);
			});
			$('#cameraCentre').click(function(e){
				var minX = parseFloat($('#boundaryBoxMinX').val());
				var minY = parseFloat($('#boundaryBoxMinY').val());
				var maxX = parseFloat($('#boundaryBoxMaxX').val());
				var maxY = parseFloat($('#boundaryBoxMaxY').val());

				var posX = (minX + maxX) / 2;
				var posY = (minY + maxY) / 2;

				if ((minX == -5) && (maxX >= 5)) posX -= Math.abs(minX)/2;
				if ((minY == -5) && (maxY >= 5)) posY -= Math.abs(minY)/2;

				viewer.cameraPosition(posX, posY);
			});
			$('#cameraZoom').click(function(e){
				var maxBB = 0;
				maxBB = Math.max(maxBB,$('#boundaryBoxMaxX').val());
				maxBB = Math.max(maxBB,$('#boundaryBoxMaxY').val());
				maxBB = Math.max(maxBB,$('#boundaryBoxMaxZ').val());
				viewer.cameraZoom(maxBB*3);

			});

			if ($('#polygoniseOnLoad').attr('checked')) {
				$('#polygonise').click();
			}

			var resizeTimeout;
			window.onresize = function() {
				clearTimeout(resizeTimeout);
				resizeTimeout = setTimeout(function() {
					viewerWidth = $('#viewer1').width();
					viewerHeight = $('#viewer1').height();
					viewer.canvasResize(viewerWidth, viewerHeight);
				}, 250); // set for 1/4 second.  May need to be adjusted.
			};

		});
	</script>
</head>
<body>

<div id="panel2">
	<div id="viewer1" class="viewer" oncontextmenu="return false;"></div>
	<div id="info1" class="info">
		<span id="viewerStats">
			<span id="X">X</span>&deg;: <span id="currAngleX"></span>
			<span id="Y">Y</span>&deg;: <span id="currAngleY"></span>
			<span id="Z">Z</span>&deg;: <span id="currAngleZ"></span>
			&nbsp;
			X: <span id="currPosX"></span>
			Y: <span id="currPosY"></span>
			&nbsp;
			D: <span id="currDepth"></span>
		</span>
		<textarea id="log1" class="log" readonly></textarea>
	</div>
	<br>
	<input type="button" value="Clear" id="clear" name="clear" />
</div>

<div id="panel1">

	<textarea id="editor1" class="editor" tabindex="1"></textarea>

	<div id="controls1" class="controls">
		<form id="controlsForm">

			<input type="button" value="Polygonise" id="polygonise" name="polygonise" />
			&nbsp;<input type="button" value="STL" id="stl" name="stl" />
			&nbsp;<input type="button" value="Reset" id="resetEditor" name="resetEditor" />
			<progress id="zProgress" max="100" value="0"></progress>&nbsp;<img id="spinner" src="images/spinner.gif">
			<br>
			Sharpen: <input class="setting" id="sharpen" name="sharpen" type="checkbox"/>
			&nbsp;Show: Normals: <input class="setting" id="showNormals" name="showNormals" type="checkbox"/>
			&nbsp;Grid: <input class="setting" id="showGrid" name="showGrid" type="checkbox"/>
			&nbsp;Axis: <input class="setting" id="showAxis" name="showAxis" type="checkbox"/>
			<br>
			<fieldset id="grid">
				<legend>Grid</legend>
				x: <input class="setting" id="gridX" name="gridX" type="number" value="40" min="0" tabindex="11"/>
				y: <input class="setting" id="gridY" name="gridY" type="number" value="40" min="0" tabindex="12"/>
				z: <input class="setting" id="gridZ" name="gridZ" type="number" value="40" min="0" tabindex="13"/>
				&nbsp;(All: <input id="gridAll" name="gridAll" class="sisyphusignore" type="number" value="" min="0" tabindex="10"/>)
			</fieldset>
			<fieldset>
				<legend>Misc.</legend>
				Workers: <input class="setting" id="numWorkers" name="numWorkers" type="number" value="4" step="1" max="8", min="0" tabindex="20"/>
				&nbsp;Isosurface: <input class="setting" id="isosurface" name="isosurface" type="number" value="0.0" step="0.1" tabindex="70"/>
			</fieldset>		
			<fieldset id="camera">
				<legend>Camera</legend>
				<input type="button" id="cameraX" value="X"/>
				<input type="button" id="cameraY" value="Y"/>
				<input type="button" id="cameraZ" value="Z"/>
				<input type="button" id="cameraIso" value="Iso"/>
				<input type="button" id="cameraCentre" value="Centre"/>
				<input type="button" id="cameraZoom" value="Zoom"/>
			</fieldset>

			<fieldset id="boundaryBox">
				<legend>Boundary Box</legend>
				Min: 
				x: <input class="setting" id="boundaryBoxMinX" name="boundaryBoxMinX" type="number" value="-10" step="0.5" tabindex="50" />
				y: <input class="setting" id="boundaryBoxMinY" name="boundaryBoxMinY" type="number" value="-10" step="0.5" tabindex="51" />
				z: <input class="setting" id="boundaryBoxMinZ" name="boundaryBoxMinZ" type="number" value="-10" step="0.5" tabindex="52" />
				&nbsp;(All: <input id="boundaryBoxMinAll" name="boundaryBoxMinAll" class="sisyphusignore" type="number" value="" step="0.5" tabindex="30"/>)
				<br>
				Max: 
				x: <input class="setting" id="boundaryBoxMaxX" name="boundaryBoxMaxX" type="number" value="15" step="0.5" tabindex="60" />
				y: <input class="setting" id="boundaryBoxMaxY" name="boundaryBoxMaxY" type="number" value="15" step="0.5" tabindex="61" />
				z: <input class="setting" id="boundaryBoxMaxZ" name="boundaryBoxMaxZ" type="number" value="15" step="0.5" tabindex="62" />
				&nbsp;(All: <input id="boundaryBoxMaxAll" name="boundaryBoxMaxAll" class="sisyphusignore" type="number" value="" step="0.5" tabindex="40"/>)
				<br>
				<a href="javascript://" id="findBoundingBox">calculate<a/>
			</fieldset>

			<br>
			LineOverlay: <input class="setting" id="lineOverlay" name="lineOverlay" type="checkbox"/>
			<br>
			Polygonise on Load: <input class="setting" id="polygoniseOnLoad" name="polygoniseOnLoad" type="checkbox"/> &nbsp;
			Zoom&amp;Centre: <input class="setting" id="zoomCentre" name="zoomCentre" type="checkbox"/>
		</form>
	</div>
</div>


</body>
</html>